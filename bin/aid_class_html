#!/usr/local/bin/perl

# does the html version of the grad-date address list

require 'mv_util.pl';
require 'tableheader.pl';
require 'getopts.pl';

$usage = 'usage: mv_class_html [-hta] infile.adr outfile
    -h        Display usage information.
    -t        Output text only
    -a        Awalt mode.
';

&Getopts('hta') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";

open(DATAPRE,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";
open(FMTOUT,">$ARGV[1]") || die "Can't open $ARGV[1]: $!\n";

if (!$opt_t) {
    print FMTOUT &common_html_hdr(($opt_a ? 3 : -1),1);
    print FMTOUT "<br>";
    $title  = $opt_a ? 'Awalt ' : '';
    $title .= "Alumni Listed by Graduating Class";
    print FMTOUT &tableheader($title, 1, 'ffff99', '000000', 1);
    print FMTOUT '
<p>Any entries marked with <img src="new.gif" alt="[new]" width="28"
height="11"> have been added to the Directory within the last month.
The <img src="info.gif" height=12 width=12 hspace=4 border=0
alt="[i]"> icon lets you get more detailed information about an
alumnus.</p>
';
    print FMTOUT "<p><a name=\"top\">Index</a>: <tt>";

    $lastYear = '1900';
    $first_fac_staff = 0;
    while(<DATAPRE>) {
	chop;

	($time,$id,$req,$last,$first,$married,
	 $school,$year,$email,$alias,$homepage,$location) = &mv_parse($_);

	if ($lastYear ne $year) {
	    $lastYear = $year;
	    if (substr($year, 0, 1) =~ /[A-Za-z]/) {
		print FMTOUT "<a href=\"#fac_staff\">Faculty/Staff</a>\n" 
		    unless $first_fac_staff;
		$first_fac_staff = 1;
	    } else {
		$hashYear = 'grad' . $year;
		print FMTOUT "<a href=\"#$hashYear\">" . 
		    $year % 100 . "</a>\n";
	    }
	}
    }
    close(DATAPRE);
    print FMTOUT "</tt></p>\n\n<pre>";
}

$info_gif = "<img src=\"info.gif\" height=12 width=12 hspace=4 border=0 alt=\"[i]\">";
$blank_gif = ($opt_t) ? "" :
    "<img src=\"blank.gif\" height=12 width=12 hspace=4 border=0 alt=\"\">";
$cgi = &mv_config('cgi_path');

print FMTOUT "Name$blank_gif                                     Email\n";
print FMTOUT "---------------------------------------------------------------------------";

open(DATA,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";
$lastYear = '1900';
$first_fac_staff = 0;
while(<DATA>) {
    chop;
    ($time,$id,$req,$last,$first,$married,
     $school,$year,$email,$alias,$homepage,$location) = &mv_parse($_);

    if ($lastYear ne $year) {
	$lastYear = $year;
	if (substr($year, 0, 1) =~ /[A-Za-z]/) {
            print FMTOUT "\n";
	    $opt_t || print FMTOUT "<a name=\"fac_staff\">" 
		unless $first_fac_staff;
            print FMTOUT $lastYear;
            $opt_t || print FMTOUT "</a>" unless $first_fac_staff;
            print FMTOUT ' ' x (13 - length($lastYear));
            $opt_t || print FMTOUT "  (<a href=\"#top\">top</a>)";
	    print FMTOUT "\n";
            $first_fac_staff = 1;
	} else {
	    $hashYear = 'grad' . $year;
	    print FMTOUT "\n";
	    $opt_t || print FMTOUT "<a name=\"$hashYear\">";
	    print FMTOUT "Class of $lastYear";
	    $opt_t || print FMTOUT "</a>  (<a href=\"#top\">top</a>)";
	    print FMTOUT "\n";
	}
    }

    $fullname = &fullname($first,$last,$married);
    $regschool = ($opt_a) ? 'Awalt' : 'MVHS';

    if ($school ne $regschool && $school ne '') {
	$affil     = "  [$school]";
    } else {
	$affil     = "";
    }

    print FMTOUT ' ';
    $opt_t || print FMTOUT "<a href=\"$cgi?about=$id\">$info_gif</a>";
    $opt_t || print FMTOUT "<a name=\"$alias\"";
    $opt_t || print FMTOUT " href=\"$homepage\"" if $homepage ne '';
    $opt_t || print FMTOUT ">";
    print FMTOUT $fullname;
    $opt_t || print FMTOUT "</a>";
    print FMTOUT $affil;
    print FMTOUT ' ', ' ' x (39 - (length($fullname) + length($affil)));
    $opt_t || print FMTOUT "<a href=\"mailto:", $email, "\">";
    print FMTOUT $email;
    $opt_t || print FMTOUT "</a>";
    $opt_t || print FMTOUT " <img alt=\"[new]\" WIDTH=28 HEIGHT=11 SRC=\"new.gif\">" if &is_new($time);
    print FMTOUT "\n";
}

$opt_t || print FMTOUT "</pre>\n";
$opt_t || print FMTOUT &common_html_ftr($opt_a ? 3 : -1);

exit(0);
