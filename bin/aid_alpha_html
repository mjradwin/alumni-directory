#!/usr/bin/perl -w

#
# does the html version of the alphabetical address list
# $Id: aid_alpha_html,v 3.22 1999/02/27 00:16:47 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';

$0 =~ s,.*/,,;  # basename
$usage = "usage: $0 [-ht] infile.db outfile
    -h        Display usage information.
    -t        Output text only
";

&Getopts('ht') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

$info_gif = &aid_image_tag('info');
$blank_gif = ($opt_t) ? "" : &aid_image_tag('blank');

$ARGV[0] =~ s/\.db$//;
die "can't open $ARGV[0].db\n" unless -r "$ARGV[0].db";
dbmopen(DB,$ARGV[0],0444);

die "no __alpha__ key!\n" unless defined $DB{'__alpha__'};

open(FMTOUT,">$ARGV[1]") || die "Can't open $ARGV[1]: $!\n";

if (!$opt_t) {
    print FMTOUT &common_html_hdr(1,'Alumni Listed by Last Name',1,
				  unpack("N",$DB{'__t__'}));
    print FMTOUT &common_intro_para(1);
    print FMTOUT "<p><a name=\"top\">Index</a>: <code>";
    # do the funky quick-jump bar
    $initial = 'A';
    while ($initial ne 'AA') {
	print FMTOUT "<a href=\"#last$initial\">$initial</a>\n";
	$initial++;
    }
    print FMTOUT "</code>";
    print FMTOUT "\n<p>\n<pre>";
}

print FMTOUT "Name and Graduation Year$blank_gif                 E-Mail\n";
print FMTOUT "---------------------------------------------------------------------------";

@alpha_ids = unpack("n*",$DB{'__alpha__'});
$initial = "Z";

foreach $id (@alpha_ids)
{
    %rec = &aid_db_unpack_rec($id,$DB{$id});
    next unless $rec{'valid'};

    $cur_initial = substr($rec{'last'}, 0, 1);
    $cur_initial = "\U${cur_initial}\E";
    if ("\U${initial}\E" ne $cur_initial) {
	print STDERR ".";
        $initial = $cur_initial;
	print FMTOUT "\n";
	$opt_t || print FMTOUT "<a name=\"last$initial\">";
	print FMTOUT $initial;
	$opt_t || print FMTOUT "</a> (<a href=\"#top\">top</a>)";
	print FMTOUT "\n";
    }

    $fullname = &fullname(*rec);
    ($affil,$len) = &affiliate(*rec,!$opt_t);

    print FMTOUT ' ';
    $opt_t || print FMTOUT "<a href=\"" . &aid_about_path(*rec) . "\">$info_gif</a>"; #'#
    $opt_t || print FMTOUT "<a name=\"$rec{'alias'}\"";
    $opt_t || print FMTOUT " href=\"$rec{'www'}\"" if $rec{'www'} ne '';
    $opt_t || print FMTOUT ">";
    print FMTOUT $fullname;
    $opt_t || print FMTOUT "</a>";
    print FMTOUT $affil;
    print FMTOUT ' ', ' ' x (39 - (length($fullname) + $len));
    $opt_t || print FMTOUT "<a href=\"mailto:", $rec{'email'}, "\">";
    print FMTOUT $rec{'email'};
    $opt_t || print FMTOUT "</a>";
    $opt_t || print FMTOUT &aid_is_new_html(*rec);
    print FMTOUT "\n";
}
print STDERR "\n";

$opt_t || print FMTOUT "</pre>\n";
$opt_t || print FMTOUT &common_html_ftr(1);

dbmclose(DB);
exit(0);
