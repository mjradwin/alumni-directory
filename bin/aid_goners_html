#!/usr/local/bin/perl -w

#
# does the html version of the invalid address list
# $Id: aid_goners_html,v 6.2 2003/08/25 05:32:04 mradwin Exp mradwin $
#
#   Copyright (c) 2003  Michael J. Radwin
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

BEGIN {
  if ($0 =~ m,(.*[/\\]),) {
    unshift @INC, $1;
  } else {
    unshift @INC, '.';
  }
}
use lib "/home/mradwin/local/share/perl";

use DB_File::Lock;
use Getopt::Std;
use aid_util;

$0 =~ s,.*/,,;  # basename
my $usage = "usage: $0 [-hq] [-i <keys>] infile.db outfile.html
    -h        Display usage information.
    -q        Quiet.
    -i <keys> Incremental update only for list of keys.
";

getopts('hi:q') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning
$opt_q = $opt_q;		# avoid warning

@incremental = ($opt_i ? split(/[,\s]+/, $opt_i) : ());

if (@incremental && (! grep(/_t_goner/, @incremental)))
{
    print STDOUT "incremental goners avoided; no _t_goner key.\n"
	unless $opt_q;
    exit(0);
}

$dbmfile = shift;
tie(%DB, 'DB_File::Lock', $dbmfile, O_RDONLY, 0444, $DB_HASH, 'read')
    or die "$dbmfile: $!\n";

die "corrupt/missing _alpha key!"
    unless defined $DB{'_alpha'} && $DB{'_alpha'} ne '';
die "corrupt/missing _t_goner key!"
    unless defined $DB{'_t_goner'} && $DB{'_t_goner'} ne '';

$outfile = shift;
open(FMTOUT,">$outfile") || die "Can't open $outfile: $!\n";

$time = unpack("N",$DB{'_t_goner'});
print FMTOUT aid_util::common_html_hdr(-1,'Alumni with Invalid Addresses',1,$time);
print FMTOUT "
<p>The following addresses are invalid because either e-mail to them
bounces, or the address is being used by a new owner.  If you know a
current e-mail address for anyone on this list, please submit it!</p>
";
print FMTOUT "<pre>";
print FMTOUT "Name and Graduation Year                  Last known whereabouts\n";
print FMTOUT "---------------------------------------------------------------------------\n";

@alpha_ids = unpack("n*",$DB{'_alpha'});
foreach $id (@alpha_ids)
{
    my %rec = aid_util::db_unpack_rec($id,$DB{$id});
    next unless $rec{'v'} == 0;

    $rec{'e'} =~ s/^[^\@]+\@/\@/;

    $fullname = aid_util::fullname(\%rec);
    ($affil,$len) = aid_util::affiliate(\%rec,0);

    print FMTOUT "<a href=\"", aid_util::config('goners_cgi'), "?upd=$rec{'id'}\">";
    print FMTOUT $fullname;
    print FMTOUT "</a>";
    print FMTOUT $affil;
    print FMTOUT ' ', ' ' x (41 - (length($fullname) + $len));
    print FMTOUT $rec{'e'};
    print FMTOUT "\n";
}

print FMTOUT "</pre>\n";
print FMTOUT aid_util::common_html_ftr(-1,$time);

untie(%DB);
close(FMTOUT);
utime $time, $time, $outfile;

# touch timestamp
$now = time;
$ts = $outfile;
$ts =~ s,([^/]+)$,\.$1,;
open(TS,">$ts") && close(TS);
utime $now, $now, $ts;

exit(0);
