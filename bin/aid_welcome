#!/usr/local/bin/perl -w

#
# mails a welcome or update note to everyone in targets.adr
# $Id: aid_welcome,v 1.27 1998/01/03 11:46:50 mjr Exp mjr $
#

require 'aid_util.pl';
require 'getopts.pl';
require 'ctime.pl';

$usage = 'usage: aid_welcome [-h] [-u | -c] targets.adr
    -h        Display usage information.
    -u        Send "update" email, not "welcome" email.
    -c        Send "confirmation" email, not "welcome" email.
';

&Getopts('huc') || die "$usage\n";
$opt_h && die "$usage\n";
($opt_c && $opt_u) && die "$usage\n";
$ARGV[0] || die "$usage\n";
$opt_h = $opt_h;                # avoid warning

$logfile = &aid_config('aiddir') . "logs/welcome.log";
$subject = ($opt_c) ? 'Confirming your MVHS Alumni Internet Directory entry' :
    ($opt_u) ? 'Your MVHS Alumni Internet Directory entry is updated' : 
    'Welcome to the MVHS Alumni Internet Directory';

$today = &ctime(time);
open(LOG,">>$logfile") || die "Can't open $logfile: $!\n";
open(TARGET,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";

select(LOG); $| = 1; select(STDOUT);

while(<TARGET>) {
    chop;
    %rec = &aid_split($_);
    next unless $rec{'email'};
    next if $opt_c && !$rec{'request'};

    $message = &message_body($_) . &message_footer;

    &sendmail($rec{'email'}, &aid_config('admin_email'), &aid_config('admin_name'),
	      $subject, $message);
    print LOG "$today $rec{'email'}\n";
}

exit(0);

sub message_body {
    local($[) = 0;
    local(%rec) = &aid_split($_[0]);
    local($denied) = ($rec{'request'}) ? '' :
	"\nSince you asked not to receive the Alumni Internet Directory via email,\nthis is the only notice you will receive.\n";

    local($about) = &about_text(*rec,1,0,0);
    local($confirming) = ($opt_c) ? 
"\nAs a service to alumni who do not have Web access, I will email a copy
of the most current Internet Directory to everyone listed in it
(including yourself) in a couple of weeks.  Please make sure your entry
below is still current.\n" : '';

    return "Dear $rec{'first'},

Your email address is listed in the Mountain View High School/Awalt High
School Alumni Internet Directory, located on the World Wide Web at:\n\n" .

"http://" . &aid_config('master_srv') . &aid_config('master_path') . "
$confirming
The directory (which produced this form letter) shows the following
information about you:

$about$denied
If you feel as if you have received this email in error or do not want
to be listed in the directory, please let me know and I will remove your
entry.  If any of the above information is incorrect or out of date, you
can update your entry online at:\n\n" .

"http://" . &aid_config('master_srv') . &aid_config('cgi_path') . "?update=$rec{'id'}

If you don't have web access, just email me corrections and I'll be happy
to fix your entry.  If everything you see above is correct, you're all set.\n";

}
