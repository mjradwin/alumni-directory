#!/usr/bin/perl -w

#
# mails a welcome or update note to everyone in targets.adr
# $Id: aid_welcome,v 3.26 1999/03/04 00:59:16 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';
require 'ctime.pl';

$0 =~ s,.*/,,;  # basename
$usage = "usage: $0 [options] targets.adr
    -h            Display usage information.
    -d <secs>     Sleep for <secs> seconds between sending e-mail
                  (default 10 for -m, 0 for all others).
    -r <reqtype>  Request type (0-3) (only valid with -m and -c).
    -l <logfile>  Log to <logfile> instead of default.

Mutually exclusive optional message types (instead of 'welcome' e-mail):
    -u            Send 'update' e-mail.
    -c            Send 'confirmation' e-mail.
    -m <textfile> Massmail the contents of <textfile>.
";

%confirm_parameters = 
    (
     'subject',  'Confirming your MVHS Alumni Internet Directory entry',
     'log',      'confirm',
     'intro', 
"\nYou were sent this address verification message because it
has been at least one year since we last confirmed your
Directory entry.  Please make sure your entry below is still
current.  If everything you see below is correct, NO ACTION
IS REQUIRED ON YOUR PART.\n",
     'textfile', '',
     'closing',  '',
     'sleep',    '0',
     );

%welcome_parameters = 
    (
     'subject',  'Welcome to the MVHS Alumni Internet Directory',
     'log',      'welcome',
     'intro',    
"\nWelcome!  This e-mail confirms that you are now listed
on-line in the Alumni Internet Directory.\n",
     'textfile', '',
     'closing',
"
Otherwise, if everything you see above is correct, you're
all set.

You might also be interested in joining the MVHS Club on
Yahoo!  The MVHS Club adds a Chat Room and Message Boards
to the services currently provided by this Directory:

  http://clubs.yahoo.com/clubs/mountainviewhighschool

Sign up for the MVHS Group on PlanetAll if you want to share
more detailed address book information (birthdays, phone
numbers, etc.) with other alumni.  People will only be
allowed to access your information with your permission, and
you can share as much or as little as you want:

  http://www.planetall.com/main.asp?cid=1520098&gid=6602&s=40
",
     'sleep',    '0',
     );

%update_parameters = 
    (
     'subject',  'Your MVHS Alumni Internet Directory entry is updated',
     'log',      'update',
     'intro',
"\nThis e-mail confirms that your contact information has been
updated and the changes are now visible on-line.\n",
     'textfile', '',
     'closing',
"
Otherwise, if everything you see above is correct, you're
all set.
",
     'sleep',    '0',
     );

%massmail_parameters = 
    (
     'subject',  'MVHS Alumni Internet Directory',
     'log',      'massmail',
     'intro',
"\nPer your request, your quarterly digest of the Directory
appears at the end of this message.  To change your e-mail
digest preferences, update your entry online at the below
update URL.\n",
     'textfile', '',
     'closing',
"
=======================================================================

MVHS NEEDS VOLUNTEER ACADEMIC TUTORS in its Tutorial Center to assist
students in one or more subject areas.  For more details, please see:
  http://www.mv.mvla.k12.ca.us/Student%20Services/Tutorial%20Center.htm
Contact George St. Clair, Coordinator: 650-940-4624; gstclair@mvla.net

=======================================================================

The following information is provided solely for the
Mountain View High School and Awalt High School communities.
Any redistribution outside of this community, or
solicitation of business or contributions from individuals
listed below is forbidden.

",
     'sleep',    '10',
     );

@args = @ARGV;

&Getopts('hd:r:ucm:l:') || die "$usage\n";
$opt_h && die "$usage\n";
$opt_h = $opt_h;                # avoid warning
die "$0: Too many mutually-exclusive options\n$usage\n"
    if (($opt_c ? 1 : 0) + ($opt_u ? 1 : 0) + ($opt_m ? 1 : 0)) > 1;
die "$0: No target file specified\n$usage\n" unless $ARGV[0];
die "$0: Option -m requires -r\n$usage\n" 
    if defined($opt_m) && !defined($opt_r);

%params = $opt_c ? %confirm_parameters : 
    $opt_u ? %update_parameters :
    $opt_m ? %massmail_parameters :
    %welcome_parameters;

$logfile = $opt_l ? $opt_l :
    &aid_config('aiddir') . "logs/" . $params{'log'} . '.log';

if ($opt_m) {
    open(TEXTFILE,$opt_m) || die "$0: Can't open $opt_m: $!\n";
    while(<TEXTFILE>) { $params{'textfile'} .= $_; }
    close(TEXTFILE);
}

$params{'sleep'} = $opt_d if defined $opt_d;

open(LOG,">>$logfile") || die "$0: Can't open $logfile: $!\n";
open(TARGET,$ARGV[0]) || die "$0: Can't open $ARGV[0]: $!\n";

select(LOG); $| = 1; select(STDOUT);

$today = &ctime(time);
chop $today;

print LOG "# [$today] - $0 ", join(' ', @args), "\n";

while(<TARGET>) {
    chop;
    %rec = &aid_split($_);
    next unless $rec{'valid'};
    next unless defined $rec{'email'} && $rec{'email'} ne '';
    next if $opt_m && $rec{'request'} != $opt_r;

    if ($opt_c) {
	next if defined $opt_r && $rec{'request'} != $opt_r;
	next unless &is_old($rec{'fresh'});
    }

    $message = &message_body($_) . $params{'textfile'} . &message_footer;

    $name  = $rec{'first'};
    $name .= " $rec{'middle'}."
	if defined $rec{'middle'} && $rec{'middle'} ne '';
    $name .= " $rec{'last'}";
    $name .= " $rec{'married'}"
	if defined $rec{'married'} && $rec{'married'} ne '';
    
    &sendmail($rec{'email'}, $name,
	      &aid_config('admin_email'), &aid_config('admin_name'),
	      $params{'subject'}, $message);
    print LOG time, " - $rec{'id'} - $rec{'email'}\n";
 
    sleep $params{'sleep'} if $params{'sleep'} > 0;
}

exit(0);

sub message_body {
    local($[) = 0;
    local(%rec) = &aid_split($_[0]);
    local($denied) = $rec{'request'} == 0 ?
	"\nSince you asked not to receive Directory updates via e-mail,\n" .
	"you will only receive yearly address verification messages.\n" :
	 '';
    local($srv_prefix) = "http://" . &aid_config('master_srv');
    local($about) = &about_text(*rec,1,0,0);

    return "Dear $rec{'first'},

This e-mail was generated automatically by the Mountain View
High School/Awalt High School Alumni Internet Directory:\n\n  " .

$srv_prefix . &aid_config('master_path') . "
$params{'intro'}
The Directory shows the following information about you:

------------------------------------------------------------
${about}------------------------------------------------------------
$denied
If any of the above information is incorrect or out of date,
update your entry online at:\n\n  " .

$srv_prefix . &aid_config('go_cgi') . "?update=$rec{'id'}

If you don't have web access, e-mail me corrections.  If you
have received this e-mail in error, or you do not want to be
listed in the Directory, please let me know and I will
remove your entry.
$params{'closing'}";

}
