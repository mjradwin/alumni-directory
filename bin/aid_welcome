#!/usr/local/bin/perl

#
# mails everyone the nifty mvhs address list
#

require 'mv_util.pl';
require 'getopts.pl';
require 'ctime.pl';

$usage = 'usage: mv_welcome [-h] [-u | -c] targets.adr
    -h        Display usage information.
    -u        Send "update" email, not "welcome" email.
    -c        Send "confirmation" email, not "welcome" email.
';

&Getopts('huc') || die "$usage\n";
$opt_h && die "$usage\n";
($opt_c && $opt_u) && die "$usage\n";
$ARGV[0] || die "$usage\n";

$today = &ctime(time);
chop $today;

$logfile = 'welcome.log';
$subject = ($opt_c) ? 'Confirming your MVHS Alumni Internet Directory entry' :
    ($opt_u) ? 'Your MVHS Alumni Internet Directory entry is updated' : 
    'Welcome to the MVHS Alumni Internet Directory';

open(LOG,">>$logfile") || die "Can't open $logfile: $!\n";
open(TARGET,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";
while(<TARGET>) {
    chop;
    ($time,$id,$req,$last,$first,$married,
     $school,$year,$email,$homepage,$location) = split(/;/);
    next unless $email;
    next if $opt_c && !$req;

    $message = &message_body($_) . &message_footer;

    &sendmail($email, &mv_config('admin_email'), &mv_config('admin_name'),
	      $subject, $message);
    print LOG "$today $email\n";
}

exit(0);


sub message_body {
    local($time,$id,$req,$last,$first,$married,
	  $school,$year,$email,$homepage,$location) = split(/;/, $_[0]);
    local($denied) = ($req) ? '' :
	"\nSince you asked not to receive the Alumni Internet Directory via email,\nthis is the only notice you will receive.\n";

    local($about) = &about_text($_[0],1,0);
    local($confirming) = ($opt_c) ? 
"\nAs a service to alumni who do not have Web access, I will email a copy
of the most current Internet Directory to everyone listed in it
(including yourself) in a couple of weeks.  Please make sure your entry
below is still current.\n" : '';

    return "Dear $first,

Your email address is listed in the Mountain View High School/Awalt High
School Alumni Internet Directory, located on the World Wide Web at:\n\n"
. &mv_config('master_url') . "
$confirming
The database (which produced this form letter) shows the following
information about you:

$about
$denied
If you feel as if you have received this email in error or do not want
to be listed in the database, please let me know and I will remove your
name from the database.  Or, if any of the above information is
incorrect or out of date you can update your entry online at:\n\n" .

&mv_config('cgi_url') . "?update=$id

or email me corrections, and I'll be happy to fix your entry. If 
everything you see above is correct, you're all set.\n";

}
