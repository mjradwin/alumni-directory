#!/usr/bin/perl -w

#
# does the html verbose pages
# $Id: aid_multi_alpha_html,v 3.23 1999/02/24 20:42:19 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';

$0 =~ s,.*/,,;  # basename
$usage = "usage: $0 [-h] infile.db
    -h        Display usage information.
";

&Getopts('h') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

$ARGV[0] =~ s/\.db$//;
die "can't open $ARGV[0].db\n" unless -r "$ARGV[0].db";
dbmopen(DB,$ARGV[0],0444);

die "no __alpha__ key!\n" unless defined $DB{'__alpha__'};

$initial = "Z";
$alpha_header = &common_html_hdr(1,'Listed by Last Name',1,
				 unpack("N",$DB{'__t__'})) .
    &common_intro_para(1);

@alpha_ids = unpack("n*",$DB{'__alpha__'});
foreach $id (@alpha_ids)
{
    %rec = &aid_db_unpack_rec($id,$DB{$id});
    next unless $rec{'valid'};

    $cur_initial = substr($rec{'last'}, 0, 1);
    $cur_initial = "\U${cur_initial}\E";
    if ("\U${initial}\E" ne $cur_initial) {
	print STDERR ".";
        $initial = $cur_initial;
	if ($initial ne 'A') {
	    print FMTOUT "</pre>\n";
	    print FMTOUT &common_html_ftr(1);
	    close(FMTOUT);
	}

	$outFile = &aid_config('wwwdir') . "alpha/\L${initial}\E-index.html";
	open(FMTOUT,">$outFile") || die "Can't open $outFile: $!\n";
	
	print FMTOUT $alpha_header,
	    "<p>\n", &alpha_jump_bar($initial), "<hr noshade size=1>\n\n";

	print FMTOUT "<pre>";
    }

    print FMTOUT &html_pre_entry(*rec,'',1);
}
print STDERR "\n";
dbmclose(DB);

print FMTOUT "</pre>\n";
print FMTOUT &common_html_ftr(1);
close(FMTOUT);

exit(0);


sub html_pre_entry {
    local(*rec,$a_name,$do_html_p) = @_;
    local($fullname,$affil,$len,$needsanchor);
    local($info_gif) = &aid_image_tag('info');
    local($retval);

    $fullname = &fullname(*rec);
    ($affil,$len) = &affiliate(*rec,1);
    $needsanchor = ($do_html_p && (($a_name ne '') ||
				   ($rec{'www'} ne ''))) ? 1 : 0;
    $retval = '';
    $retval .= "<a href=\"" . &aid_about_path(*rec) . "\">$info_gif</a>" #'#
	if $do_html_p;
    $retval .= "<a" if $needsanchor;
    $retval .= " name=\"$a_name\"" if ($do_html_p && $a_name ne '');
    $retval .= " href=\"$rec{'www'}\"" if ($do_html_p && $rec{'www'} ne '');
    $retval .= ">" if $needsanchor;
    $retval .= $fullname;
    $retval .= "</a>" if $needsanchor;
    $retval .= $affil;
    $retval .= ' ' . ' ' x (41 - (length($fullname) + $len));
    $retval .= "<a href=\"mailto:" . $rec{'email'} . "\">" if $do_html_p;
    $retval .= $rec{'email'};
    $retval .= "</a>" if $do_html_p;
    $retval .= " " . &aid_image_tag('new_anchored')
	if ($do_html_p && &is_new($rec{'time'}));
    $retval .= "\n";

    $retval;
}

# do the funky quick-jump bar
sub alpha_jump_bar {
    local($regular) = @_;
    local($initial,$retval);

    $retval = '';
    $initial = 'a';
    $regular = "\L${regular}\E";

    while ($initial ne 'aa') {
	if ($initial ne 'x')
	{
	$retval .= (($regular eq $initial) ?
		    "\U${initial}\E\n" :
		    "<a href=\"${initial}-index.html\">\U${initial}\E</a>\n");
    	}
	$initial++;
    }

    $retval;
}
