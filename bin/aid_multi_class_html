#!/usr/bin/perl -w

#
# does the html verbose pages
# $Id: aid_verbose_html,v 3.10 1998/05/17 05:18:53 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';
require 'ctime.pl';

$usage = 'usage: aid_verbose_html [-h] infile.adr
    -h        Display usage information.
';

&Getopts('h') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

@years = &get_class_array($ARGV[0]);

open(DATA,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";

# first valid only
while(<DATA>) {
    chop;
    %rec = &aid_parse($_);
    last if $rec{'valid'};
}


$verbose_header = &common_intro_para(0) .
    "<p>\n" . &class_jump_bar(*years) . "<hr noshade size=1>\n\n";

# main loop
for(;;) {
    $currentYear = $rec{'year'};
    $outFile = &aid_config('wwwdir') . "class/" .
	(($rec{'year'} =~ /^\d+$/) ? $rec{'year'} : "other") . ".html";
    open(FMTOUT,">$outFile") || die "Can't open $outFile: $!\n";

    $title  = ($rec{'year'} =~ /^\d+$/) ? "Class of $rec{'year'}" :
	"Faculty and Staff";
    print FMTOUT &common_html_hdr(-1,$title,1);
    print FMTOUT $verbose_header;

    &aid_write_verbose_entry(*FMTOUT,*rec);
    while(<DATA>) {
	chop;
	%rec = &aid_parse($_);
	next unless $rec{'valid'};
	
	last if (($rec{'year'} ne $currentYear) && ($currentYear =~ /^\d+$/));
	&aid_write_verbose_entry(*FMTOUT,*rec);
    }
    print FMTOUT &common_html_ftr(-1);
    close(FMTOUT);

    last if eof(DATA);
}

$outFile = &aid_config('wwwdir') . "class/index.html";
open(FMTOUT,">$outFile") || die "Can't open $outFile: $!\n";

print FMTOUT &common_html_hdr(2,'Alumni Listed by Graduating Class',0);

print FMTOUT "<p align=center><font size=\"+1\">By&nbsp;Class:<br>\n";
print FMTOUT &class_jump_bar(*years);
print FMTOUT "</font></p>\n";

print FMTOUT "<p align=center><font size=\"+1\">";
print FMTOUT "Compact&nbsp;Form:<br>\n";
print FMTOUT "<a href=\"" . &aid_config('master_path') . "class.html\">";
print FMTOUT "All&nbsp;Alumni</a> |\n";
print FMTOUT "<a href=\"" . &aid_config('master_path') . "awalt.html\">";
print FMTOUT "Awalt&nbsp;Alumni</a></font></p>\n";

print FMTOUT &common_html_ftr(2);
close(FMTOUT);

exit(0);

sub class_jump_bar {
    local(*years) = @_;
    local($year,$retval);

    $retval = '';
    foreach $year (@years) {
	$retval .= "<a href=\"" . &aid_config('master_path');
	$retval .= "class/${year}.html\">";
	$retval .= ($year eq 'other') ? "Faculty/Staff" : $year % 100;
	$retval .= "</a>";
	$retval .= " |" unless $year eq 'other';
	$retval .= "\n";
    }

    $retval;
}

sub get_class_array {
    local($inFile) = @_;
    local(@years,$prev);
    local(*BYCLASS,*rec);
    local($_);

    @years = ();
    $prev = '1900';

    open(BYCLASS,$inFile) || die "Can't open $inFile: $!\n";
    while(<BYCLASS>) {
        chop;
        %rec = &aid_split($_);
        next unless $rec{'valid'};
 
        if ($prev ne $rec{'year'}) {
            $prev = $rec{'year'};
            if (substr($rec{'year'}, 0, 1) =~ /[A-Za-z]/) {
		push(@years, 'other');
                last;
            } else {
		push(@years, $rec{'year'});
            }
        }
    }
    close(BYCLASS);
    
    @years;
}
