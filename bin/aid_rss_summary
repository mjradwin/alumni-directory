#!/usr/local/bin/perl5 -w

#
#     FILE: aid_rss_summary.pl
#   AUTHOR: Michael J. Radwin
#    DESCR: creates an RDF Site Summary for the Directory
#      $Id: aid_rss_summary,v 1.8 2000/02/29 21:55:00 mradwin Exp mradwin $
#
#   Copyright (c) 1995-1999  Michael John Radwin
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

$dirname = $0;
$dirname =~ s,/[^/]+$,,;
unshift(@INC, $dirname);

use DB_File;

require 'aid_util.pl';
require 'ctime.pl';
require 'getopts.pl';

$0 =~ s,.*/,,;  # basename
$usage = "usage: $0 [-h] infile.db outfile.rdf
    -h        Display usage information.
";

&Getopts('h') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

$dbmfile = shift;
tie(%DB, 'DB_File', $dbmfile, O_RDONLY, 0444, $DB_File::DB_HASH)
    or die "$dbmfile: $!\n";

die "corrupt/missing _t key!" unless defined $DB{'_t'} && $DB{'_t'} ne '';
$time = unpack("N",$DB{'_t'});

die "corrupt/missing _class key!"
    unless defined $DB{'_class'} && $DB{'_class'} ne '';
@class = unpack("n*", $DB{'_class'});

$newest = 0;
if (defined $DB{'_nextid'})
{
    for ($i = $DB{'_nextid'} - 1; $i > 0; $i--)
    {
	if (defined $DB{$i})
	{
	    %rec = &aid_db_unpack_rec($i,$DB{$i});
	    next unless $rec{'v'};
	    $newest = $i;
	    %newest = %rec;
	    last;
	}
    }
}

die "corrupt database: couldn't find a valid newest entry!" if ($newest == 0);

foreach (@class)
{
    %rec = &aid_db_unpack_rec($_,$DB{$_});
    next unless $rec{'v'};
    $upd{$rec{'u'}} = $rec{'id'};
}

$found = 0;
foreach (reverse sort keys %upd)
{
    next if $_ == $newest{'u'};
    %rec = &aid_db_unpack_rec($upd{$_},$DB{$upd{$_}});
    $found = 1;
    last;
}

$outfile = shift;
open(FMTOUT,">$outfile") || die "Can't open $outfile: $!\n";

print FMTOUT
"<?xml version=\"1.0\"?>
<!DOCTYPE rss PUBLIC \"-//Netscape Communications//DTD RSS 0.91//EN\"
\t\"http://my.netscape.com/publish/formats/rss-0.91.dtd\">
<rss version=\"0.91\">
<channel>

<title>" . &aid_config('short_school') . " Alumni Internet Directory</title>
<link>http://" . &aid_config('master_srv') . &aid_config('master_path') .
    "</link>
<description>" . &aid_config('descr_long') . "</description>
<language>en-us</language>

";

if ($found)
{
    print FMTOUT
"<item>
<title>Updated " . &aid_caldate($rec{'u'}) . ": " . 
    &aid_html_entify_str(&aid_inorder_fullname(*rec)) . "</title>
<link>http://" . &aid_config('master_srv') .
    &aid_about_path(*rec,0) . "</link>
</item>

";
}

print FMTOUT
"<item>
<title>Joined " . &aid_caldate($newest{'c'}) . ": " .
    &aid_html_entify_str(&aid_inorder_fullname(*newest)) . "</title>
<link>http://" . &aid_config('master_srv') .
    &aid_about_path(*newest,0) . "</link>
</item>

";

print FMTOUT
"<item>
<title>Graduating Classes</title>
<link>http://" . &aid_config('master_srv') . &aid_config('master_path') . 
    "class/</link>
</item>

<item>
<title>Reunions</title>
<link>http://" . &aid_config('master_srv') . &aid_config('master_path') .
    "etc/reunions.html</link>
</item>

</channel>
</rss>
";

untie(%DB);

close(FMTOUT);
utime $time, $time, $outfile;

# touch timestamp
$now = time;
$ts = $outfile;
$ts =~ s,([^/]+)$,\.$1,;
open(TS,">$ts") && close(TS);
utime $now, $now, $ts;
exit(0);
