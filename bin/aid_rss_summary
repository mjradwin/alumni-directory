#!/usr/local/bin/perl -w

#
#     FILE: aid_rss_summary.pl
#   AUTHOR: Michael J. Radwin
#    DESCR: creates an RDF Site Summary for the Directory
#      $Id: aid_rss_summary,v 1.14 2002/11/20 18:06:21 mradwin Exp mradwin $
#
#   Copyright (c) 1995-1999  Michael John Radwin
#
#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#

$dirname = $0;
$dirname =~ s,/[^/]+$,,;
unshift(@INC, $dirname);

use DB_File;

require 'aid_util.pl';
require 'ctime.pl';
use Getopt::Std;

$0 =~ s,.*/,,;  # basename
my $usage = "usage: $0 [-h] infile.db outfile.rdf
    -h        Display usage information.
";

getopts('h') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

my $dbmfile = shift;
my %DB;
tie(%DB, 'DB_File', $dbmfile, O_RDONLY, 0444, $DB_File::DB_HASH)
    or die "$dbmfile: $!\n";

die "corrupt/missing _t key!" unless defined $DB{'_t'} && $DB{'_t'} ne '';
my $time = unpack("N",$DB{'_t'});

die "corrupt/missing _nextid key!"
    unless defined $DB{'_nextid'} && $DB{'_nextid'} ne '';

my %id_by_ts;
for (my $i = $DB{'_nextid'} - 1; $i > 0; $i--)
{
    if (defined $DB{$i})
    {
	my %rec = &aid_db_unpack_rec($i,$DB{$i});
	next unless $rec{'v'};
	$id_by_ts{$i} = $rec{'u'};
    }
}

my $outfile = shift;
open(FMTOUT,">$outfile") || die "Can't open $outfile: $!\n";

# find out the next reunion
my $reunion_yr = 'x';
my $reunion_t = 2147483648; 

if ($ARGV[0])
{
    my(%RDB);
    my $r_dbmfile = shift;
    tie(%RDB, 'DB_File', $r_dbmfile, O_RDONLY, 0444, $DB_File::DB_HASH)
	or die "$r_dbmfile: $!\n";

    my $now = time;
    while (my($key,$val) = each(%RDB))
    {
	next if $key =~ /^_/;
	my($date,$html) = split(/\0/, $val, 2);
	my($yr,$mon,$mday) = split(/\//, $date, 3);
	my $t = &Time::Local::timelocal(59,59,23,$mday,$mon-1,$yr-1900,0,0,0);
	if ($t > $now && $t < $reunion_t)
	{
	    $reunion_t = $t;
	    $reunion_yr = $key;
	}
    }
    untie(%RDB);
}

print FMTOUT
"<?xml version=\"1.0\" encoding=\"iso-8859-1\"?>
<rss version=\"0.91\">
<channel>

<title>" . &aid_config('short_school') . " Alumni Internet Directory</title>
<link>http://" . &aid_config('master_srv') . &aid_config('master_path') .
    "recent.html</link>
<description>" . &aid_config('descr_long') . "</description>
<language>en-us</language>

";

my @ids;
foreach my $i (sort {$id_by_ts{$b} <=> $id_by_ts{$a}} keys %id_by_ts)
{
    push(@ids, $i);
    last if scalar(@ids) == 10;
}

foreach my $i (@ids) {
    my %rec = &aid_db_unpack_rec($i,$DB{$i});
    print FMTOUT
"<item>
<title>" .  &aid_html_entify_str(&aid_inorder_fullname(*rec)) .
" - " . &aid_caldate($rec{'u'}) . "</title>
<link>http://" . &aid_config('master_srv') .
    &aid_about_path(*rec,0) . "</link>
<description>Class of " . &aid_html_entify_str($rec{'yr'}), ".";

    if ($rec{'n'}) {
	print FMTOUT " ", &aid_html_entify_str($rec{'n'});
    }

    print FMTOUT "</description>\n</item>\n\n";
}

if ($reunion_yr ne 'x')
{
    my($refname,$title);
    if ($reunion_yr =~ /^\d+$/)
    {
	$refname = "r$reunion_yr";
	$title = "Class of $reunion_yr";
    }
    else
    {
	$refname = lc($reunion_yr);
	$refname =~ s/[^\w]/_/g;
	$refname =~ s/_+/_/g;
	$refname =~ s/^_//;
	$refname =~ s/_$//;

	$title = &aid_html_entify_str($reunion_yr);
    }

    my $long_date = &POSIX::strftime("%A, %B %e, %Y", localtime($reunion_t));

    print FMTOUT
"<item>
<title>Reunion: $title</title>
<link>http://" . &aid_config('master_srv') . &aid_config('master_path') . 
    "etc/reunions.html#$refname</link>
<description>$long_date</description>
</item>
";
}

print FMTOUT
"</channel>
</rss>
";

untie(%DB);

close(FMTOUT);
utime $time, $time, $outfile;

# touch timestamp
my $now = time;
my $ts = $outfile;
$ts =~ s,([^/]+)$,\.$1,;
open(TS,">$ts") && close(TS);
utime $now, $now, $ts;
exit(0);
