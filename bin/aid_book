#!/usr/bin/perl -w

#
# generates address books in several formats
# $Id: aid_book,v 3.19 1998/11/26 00:51:51 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';

$usage = 'usage: aid_book [-h] infile.db -{p,e,b,w,m,n,l,v,o} outfile
    -h        Display usage information.

    -p        Pine address book
    -e        Elm aliases
    -b        Berkeley Mail aliases
    -w        Eudora 2 nicknames
    -m        Eudora 3/4 nicknames
    -n        Netscape3 address book
    -l        Netscape4 .ldif address book
    -v        vCard book
    -o        Outlook Express .csv
';

# get the command-line options and die if there is a bad option or
# there are no filenames
&Getopts('hp:e:b:w:m:n:l:v:o:') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$opt_h = $opt_h;		# avoid warning

# must have at least 1 option
die "$usage\n" unless
    $opt_p || $opt_e || $opt_b || $opt_w || 
    $opt_m || $opt_n || $opt_l || $opt_v || $opt_o;

$ARGV[0] =~ s/\.db$//;
die "can't open $ARGV[0].db\n" unless -r "$ARGV[0].db";
dbmopen(DB,$ARGV[0],0444);

die "no __alpha__ key!\n" unless defined $DB{'__alpha__'};

if ($opt_p) { open(BOOKp,">$opt_p") || die "Can't open $opt_p: $!\n"; }
if ($opt_e) { open(BOOKe,">$opt_e") || die "Can't open $opt_e: $!\n"; }
if ($opt_b) { open(BOOKb,">$opt_b") || die "Can't open $opt_b: $!\n"; }
if ($opt_w) { open(BOOKw,">$opt_w") || die "Can't open $opt_w: $!\n"; }
if ($opt_m) { open(BOOKm,">$opt_m") || die "Can't open $opt_m: $!\n"; }
if ($opt_n) { open(BOOKn,">$opt_n") || die "Can't open $opt_n: $!\n"; }
if ($opt_l) { open(BOOKl,">$opt_l") || die "Can't open $opt_l: $!\n"; }
if ($opt_v) { open(BOOKv,">$opt_v") || die "Can't open $opt_v: $!\n"; }
if ($opt_o) { open(BOOKo,">$opt_o") || die "Can't open $opt_o: $!\n"; }

$opt_p && &aid_book_write_prefix(*BOOKp,'p');
$opt_e && &aid_book_write_prefix(*BOOKe,'e');
$opt_b && &aid_book_write_prefix(*BOOKb,'b');
$opt_w && &aid_book_write_prefix(*BOOKw,'w');
$opt_m && &aid_book_write_prefix(*BOOKm,'m');
$opt_n && &aid_book_write_prefix(*BOOKn,'n');
$opt_l && &aid_book_write_prefix(*BOOKl,'l');
$opt_v && &aid_book_write_prefix(*BOOKv,'v');
$opt_o && &aid_book_write_prefix(*BOOKo,'o');

@alpha_ids = unpack("n*",$DB{'__alpha__'});
foreach $id (@alpha_ids)
{
    %rec = &aid_db_unpack_rec($id,$DB{$id});
    next unless $rec{'valid'};
    
    $opt_p && &aid_book_write_entry(*BOOKp,'p',*rec);
    $opt_e && &aid_book_write_entry(*BOOKe,'e',*rec);
    $opt_b && &aid_book_write_entry(*BOOKb,'b',*rec);
    $opt_w && &aid_book_write_entry(*BOOKw,'w',*rec);
    $opt_m && &aid_book_write_entry(*BOOKm,'m',*rec);
    $opt_n && &aid_book_write_entry(*BOOKn,'n',*rec);
    $opt_l && &aid_book_write_entry(*BOOKl,'l',*rec);
    $opt_v && &aid_book_write_entry(*BOOKv,'v',*rec);
    $opt_o && &aid_book_write_entry(*BOOKo,'o',*rec);

}

dbmclose(DB);

$opt_p && &aid_book_write_suffix(*BOOKp,'p');
$opt_e && &aid_book_write_suffix(*BOOKe,'e');
$opt_b && &aid_book_write_suffix(*BOOKb,'b');
$opt_w && &aid_book_write_suffix(*BOOKw,'w');
$opt_m && &aid_book_write_suffix(*BOOKm,'m');
$opt_n && &aid_book_write_suffix(*BOOKn,'n');
$opt_l && &aid_book_write_suffix(*BOOKl,'l');
$opt_v && &aid_book_write_suffix(*BOOKv,'v');
$opt_o && &aid_book_write_suffix(*BOOKo,'o');

$opt_p && close(BOOKp);
$opt_e && close(BOOKe);
$opt_b && close(BOOKb);
$opt_w && close(BOOKw);
$opt_m && close(BOOKm);
$opt_n && close(BOOKn);
$opt_l && close(BOOKl);
$opt_v && close(BOOKv);
$opt_o && close(BOOKo);

exit(0);
