#!/usr/local/bin/perl

#
# generates address books in several formats
# $Id: aid_book,v 1.20 1998/01/02 20:14:18 mradwin Exp $
#

require 'aid_util.pl';
require 'getopts.pl';

$usage = 'usage: aid_book [-h] infile.adr -{p,e,b,w,m,n,l,v} outfile
    -h        Display usage information.

    -p        Pine address book
    -e        Elm aliases
    -b        Berkeley Mail aliases
    -w        Eudora for Windows nicknames
    -m        Eudora Pro for Macintosh nicknames
    -n        Netscape3 address book
    -l        Netscape4 .ldif address book
    -v        vCard book
';

# get the command-line options and die if there is a bad option or
# there are no filenames
&Getopts('hp:e:b:w:m:n:l:v:') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";

# must have at least 1 option
die "$usage\n" unless
    $opt_p || $opt_e || $opt_b || $opt_w || 
    $opt_m || $opt_n || $opt_l || $opt_v;

open(DATA,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";

$opt_p && open(BOOKp,">$opt_p") || die "Can't open $opt_p: $!\n";
$opt_e && open(BOOKe,">$opt_e") || die "Can't open $opt_e: $!\n";
$opt_b && open(BOOKb,">$opt_b") || die "Can't open $opt_b: $!\n";
$opt_w && open(BOOKw,">$opt_w") || die "Can't open $opt_w: $!\n";
$opt_m && open(BOOKm,">$opt_m") || die "Can't open $opt_m: $!\n";
$opt_n && open(BOOKn,">$opt_n") || die "Can't open $opt_n: $!\n";
$opt_l && open(BOOKl,">$opt_l") || die "Can't open $opt_l: $!\n";
$opt_v && open(BOOKv,">$opt_v") || die "Can't open $opt_v: $!\n";

$opt_p && &write_prefix(*BOOKp,'p');
$opt_e && &write_prefix(*BOOKe,'e');
$opt_b && &write_prefix(*BOOKb,'b');
$opt_w && &write_prefix(*BOOKw,'w');
$opt_m && &write_prefix(*BOOKm,'m');
$opt_n && &write_prefix(*BOOKn,'n');
$opt_l && &write_prefix(*BOOKl,'l');
$opt_v && &write_prefix(*BOOKv,'v');

while(<DATA>) {
    chop;
    ($alias,
     $time,$id,$req,$last,$first,$married,
     $school,$year,$email,$homepage,$location) = &aid_parse($_);
    
    $opt_p && &write_entry(*BOOKp,'p',
			   $alias,
			   $time,$id,$req,$last,$first,$married,
			   $school,$year,$email,$homepage,$location);
    $opt_e && &write_entry(*BOOKe,'e',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_b && &write_entry(*BOOKb,'b',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_w && &write_entry(*BOOKw,'w',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_m && &write_entry(*BOOKm,'m',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_n && &write_entry(*BOOKn,'n',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_l && &write_entry(*BOOKl,'l',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
    $opt_v && &write_entry(*BOOKv,'v',
                           $alias,
			   $time,$id,$req,$last,$first,$married,
                           $school,$year,$email,$homepage,$location);
}

close(DATA);

$opt_p && &write_suffix(*BOOKp,'p');
$opt_e && &write_suffix(*BOOKe,'e');
$opt_b && &write_suffix(*BOOKb,'b');
$opt_w && &write_suffix(*BOOKw,'w');
$opt_m && &write_suffix(*BOOKm,'m');
$opt_n && &write_suffix(*BOOKn,'n');
$opt_l && &write_suffix(*BOOKl,'l');
$opt_v && &write_suffix(*BOOKv,'v');

$opt_p && close(BOOKp);
$opt_e && close(BOOKe);
$opt_b && close(BOOKb);
$opt_w && close(BOOKw);
$opt_m && close(BOOKm);
$opt_n && close(BOOKn);
$opt_l && close(BOOKl);
$opt_v && close(BOOKv);

exit(0);

sub write_prefix {
    local(*BOOK,$option) = @_;

    # special case for netscape
    if ($option eq 'n') {
	print BOOK "<!DOCTYPE NETSCAPE-Addressbook-file-1>
<!-- This is an automatically generated file.
It will be read and overwritten.
Do Not Edit! -->
<TITLE>MVHS Alumni Address book</TITLE>
<H1>MVHS Alumni Address book</H1>

<DL><p>\n";
    }
}

sub write_entry {
    local(*BOOK,$option,
	  $alias,
	  $time,$id,$req,$last,$first,$married,
	  $school,$year,$email,$homepage,$location) = @_;
    
    $last = "$last $married" if $married ne '';

    $option eq 'p' && print BOOK "$alias\t$last, $first\t$email\t\t$school $year\n";
    $option eq 'e' && print BOOK "$alias = $last; $first, $school $year = $email\n";
    $option eq 'b' && print BOOK "alias $alias\t$email\n";
    $option eq 'w' && print BOOK "<$alias>\n>$first $last <$email>\n<$alias>\n>$school $year\n";
    $option eq 'm' && print BOOK "alias $alias $email\nnote $alias <name:$first $last>$school $year\n";

    # netscape is a bigger sucker
    if ($option eq 'n') {
	print BOOK "    <DT><A HREF=\"mailto:$email\" ";
	print BOOK "NICKNAME=\"$alias\">$first $last</A>\n";
	print BOOK "<DD>$school $year\n";
    }

    elsif ($option eq 'l') {
        print BOOK "dn: cn=$first $last,mail=$email\n";
        print BOOK "cn: $first $last\n";
        print BOOK "sn: $last\n";
        print BOOK "givenname: $first\n";
        print BOOK "objectclass: top\nobjectclass: person\n";
        print BOOK "mail: $email\n";
        print BOOK "locality: $location\n" if $location ne '';
        print BOOK "o: $school $year\n";
        print BOOK "xmozillanickname: $alias\n";
        print BOOK "\n";
    }
    
    # lots of data for a vCard
    elsif ($option eq 'v') {
	print BOOK "Begin:vCard\nORG:$school $year;\nFN:$first $last\n";
	print BOOK "N:$last;$first\nEMAIL;PREF;INTERNET:$email\n";
	print BOOK "URL:$homepage\n" if $homepage ne '';
	print BOOK "End:vCard\n\n";
    }
}

sub write_suffix {
    local(*BOOK,$option) = @_;

    $option eq 'n' && print BOOK "</DL><p>\n";
}

