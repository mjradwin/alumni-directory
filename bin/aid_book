#!/usr/local/bin/perl
#
# converts UC-Update type alias file into a
# pine-style address book
#



require 'mv_util.pl';
require 'getopts.pl';

$usage = 'usage: mv_book [-h] -{p,e,b,w,m,n,v} infile.adr outfile
    -h        Display usage information.

    -p        Pine address book
    -e        Elm aliases
    -b        Berkeley Mail aliases
    -w        Eudora for Windows nicknames
    -m        Eudora Pro for Macintosh nicknames
    -n        Netscape address book
    -v        vCard book
';

# get the command-line options and die if there is a bad option or
# there are no filenames
&Getopts('hpebwmnv') || die "$usage\n";
$opt_h && die "$usage\n";
$ARGV[0] || die "$usage\n";
$ARGV[1] || die "$usage\n";

# must have at least 1 option
$opt_p || $opt_e || $opt_b || $opt_w || $opt_m || $opt_n || $opt_v ||
    die "$usage\n";

open(MVHS,$ARGV[0]) || die "Can't open $ARGV[0]: $!\n";
open(BOOK,">$ARGV[1]") || die "Can't open $ARGV[1]: $!\n";

# special case for netscape
if ($opt_n) {
    print BOOK "<!DOCTYPE NETSCAPE-Addressbook-file-1>
<!-- This is an automatically generated file.
It will be read and overwritten.
Do Not Edit! -->
<TITLE>MVHS Alumni Address book</TITLE>
<H1>MVHS Alumni Address book</H1>

<DL><p>\n";
}

while(<MVHS>) {
    chop;
    ($time,$id,$req,$last,$first,$married,
     $school,$year,$email,$alias,$homepage) = &mv_parse($_);
    
    if ($aliases{$alias} > 0) {
	$aliases{$alias} = $aliases{$alias} + 1;
	$alias = substr($alias, 0, 7) . $aliases{$alias};
    } else {
	$aliases{$alias} = 1;
    }

    $opt_p && print BOOK "$alias\t$last, $first\t$email\t\t$school $year\n";
    $opt_e && print BOOK "$alias = $last; $first, $school $year = $email\n";
    $opt_b && print BOOK "alias $alias\t$email\n";
    $opt_w && print BOOK "<$alias>\n>$first $last <$email>\n<$alias>\n>$school $year\n";
    $opt_m && print BOOK "alias $alias $email ($first $last)\nnote $alias $school $year\n";

    # netscape is a bigger sucker
    if ($opt_n) {
	print BOOK "    <DT><A HREF=\"mailto:$email\" ";
	print BOOK "NICKNAME=\"$alias\">$first $last</A>\n";
	print BOOK "<DD>$school $year\n";
    }
    
    # lots of data for a vCard
    if ($opt_v) {
	print BOOK "Begin:vCard\nORG:$school $year;\nFN:$first $last\n";
	print BOOK "N:$last;$first\nEMAIL;PREF;INTERNET:$email\n";
	print BOOK "URL:$homepage\n" if $homepage ne '';
	print BOOK "End:vCard\n\n";
    }
}

$opt_n && print BOOK "</DL><p>\n";
close(MVHS);
close(BOOK);

exit(0);
