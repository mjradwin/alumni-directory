#!/usr/bin/perl -w

#
# does the html version of just home pages
# $Id: aid_home_html,v 3.27 1999/02/27 02:00:14 mradwin Exp mradwin $
#

require 'aid_util.pl';
require 'getopts.pl';

$0 =~ s,.*/,,;  # basename
$usage = "usage: $0 [-hs] [-i <infile>] -p <pg> -t <text> <outfile>
 -h            Display usage information.
 -s            Create the submit page.
 -d            Create the download page.
 -i <infile>   Create an 'other' page from html code in <infile>.
 -p <pg>       Use page number <pg> for generating content.  REQUIRED.
 -t <text>     Put a tableheader with 'text'.  REQUIRED.

 <outfile>     Write results to <outfile>.

Either -s, -d or -i must be supplied.  They are mutuallly exclusive.
";

&Getopts('hst:i:p:d') || die "$usage\n";
$opt_h && die "$usage\n";
$opt_h = $opt_h;		# avoid warning
%blank_entry = %aid_util'blank_entry = %aid_util'blank_entry;

die "$usage\n" unless $ARGV[0];
die "$usage\n"
    unless ($opt_s ? 1 : 0) + ($opt_i ? 1 : 0) + ($opt_d ? 1 : 0) == 1;
die "$usage\n" unless defined($opt_p);
die "$usage\n" unless defined($opt_t);

$infile = $opt_i;
$outfile = $ARGV[0];
$dbmfile = &aid_config('wwwdir') . 'master';

if ($opt_i)
{
    open(INFILE,$infile) || die "Can't open $infile: $!\n";
    $time = (stat(INFILE))[9];
    @lines = <INFILE>;
    close(INFILE);
}
else
{
    die "can't open ${dbmfile}.db\n" unless -r "${dbmfile}.db";
    dbmopen(DB,$dbmfile,0444);

    die "no __t__ key!\n" unless defined $DB{'__t__'};
    $time = unpack("N",$DB{'__t__'});
}

if ($opt_i && $opt_p == 0)
{
    die "can't open ${dbmfile}.db\n" unless -r "${dbmfile}.db";
    dbmopen(DB,$dbmfile,0444);
    die "no __t__ key!\n" unless defined $DB{'__t__'};
    $time = unpack("N",$DB{'__t__'});
    dbmclose(DB);
}

open(OUTFILE,">$outfile") || die "Can't open $outfile: $!\n";
print OUTFILE &common_html_hdr($opt_p,$opt_t,0,$time);

if ($opt_s) {
    print OUTFILE &submit_body(*blank_entry,'');

} elsif ($opt_d) {
    die "no __years__ key!\n" unless defined $DB{'__years__'};
    @years = unpack("n*",$DB{'__years__'});
    push(@years, 'other');

    print OUTFILE "<p>Before downloading nickname and address book files
for your e-mail program, please read the
<a href=\"", &aid_config('master_path'), "etc/copyright.html\">Acceptable
Use Policy</a>.</p>

<p>You may need to use the \"import\" feature to merge the address book
with your own.  Aliases (also called nicknames) are of the form
<code><strong>flllllll</strong></code> where
<code><strong>f</strong></code> is first initial and
<code><strong>l</strong></code> is last name.  If there are duplicates
such as John Smith and Jane Smith, then the first one will be
<code><strong>jsmith</strong></code> and the second will be
<code><strong>jsmith2</strong></code>.</p>\n\n";

    print OUTFILE "<p><form method=\"get\" action=\"";
    print OUTFILE &aid_config('download_cgi') . "\">\n";
    print OUTFILE "<input type=\"hidden\" name=\"download\" value=\"1\">\n\n";

    print OUTFILE "<label for=\"email\">Your e-mail address:&nbsp;</label>\n";
    print OUTFILE "<input type=\"text\" name=\"email\" size=\"25\" ";
    print OUTFILE "value=\"\" id=\"email\"> (for logging purposes only)\n";

    print OUTFILE "<br><label for=\"year\">Year to download:&nbsp;</label>\n";
    print OUTFILE "<select name=\"year\" id=\"year\">\n";
    foreach (@years)
    {
	print OUTFILE "<option";
	print OUTFILE " selected" if $_ eq '1993';
	print OUTFILE ">$_\n" unless $_ eq 'other';
	print OUTFILE " value=\"other\">Faculty/Staff\n" if $_ eq 'other';
    }
    print OUTFILE "</select>\n";

    print OUTFILE "<br><label for=\"format\">Format:&nbsp;</label>
<select name=\"format\" id=\"format\">
<option value=\"n\">Netscape 2.x
<option value=\"n\">Netscape 3.x
<option value=\"l\">Netscape 4.x
<option value=\"w\">Eudora 2.x
<option value=\"m\">Eudora 3.x
<option value=\"m\">Eudora 4.x
<option value=\"o\" selected>Outlook Express .CSV
<option value=\"p\">Pine (Unix)
<option value=\"e\">Elm (Unix)
<option value=\"b\">Berkeley Mail (Unix)
</select>

<br>

<input type=checkbox name=\"plusminus\" id=\"plusminus\"><label
for=\"plusminus\">&nbsp;Also download graduating classes 3 years before and 3
years after mine.</label>

<br>

<input type=\"submit\" value=\"Download\">
</form><p>\n\n";

} else { # implicit opt_i
    print OUTFILE @lines;
}
print OUTFILE &common_html_ftr($opt_p);

dbmclose(DB) unless $opt_i;
close(OUTFILE);
utime $time, $time, $outfile;

# touch timestamp
$now = time;
$ts = $outfile;
$ts =~ s,([^/]+)$,\.$1,;
open(TS,">$ts") && close(TS);
utime $now, $now, $ts;

exit(0);
