#!/usr/local/bin/perl

#
#     FILE: mvhsaid.pl
#   AUTHOR: Michael J. Radwin
#    DESCR: MVHS Alumni Internet Directory CGI interface
#      $Id: mvhsaid,v 1.56 1998/01/02 20:17:33 mjr Exp mjr $
#

require 'aid_util.pl';
require 'cgi-lib.pl';

# configuration
$mailprog = &aid_config('mailprog');
$dbfile = &aid_config('wwwdir') . "master.adr";

@required_headers = ('id', 'last', 'first', 'school', 'grad', 'mail');

&ReadParse();

# convert "cgi-bin/mvhsaid/vcard/123.vcf" to "cgi-bin/mvhsaid?vcard=123"
if ($ENV{'PATH_INFO'} =~ m,^/vcard/,) {
    $in{'vcard'} = $ENV{'PATH_INFO'};
    $in{'vcard'} =~ s,^/vcard/(\d+).*$,$1,;
}

$rcsid = '$Id: mvhsaid,v 1.56 1998/01/02 20:17:33 mjr Exp mjr $'; #'fnt

# special flags: version, update, vcard, about
#
# if any of these flags is set, we're sending back a dynamic page
# instead of processing a form request.
if (defined($in{'version'})) {
    select(STDOUT);  $| = 1;
    print "Content-type: text/plain\n\n$rcsid\n";
    print &aid_config('rcsid'), "\n";
    exit(0);

} elsif (defined($in{'update'})) {
    if ($in{'update'} =~ /^\d+$/) {
	@db = &aid_create_db($dbfile);
	if (defined($db[$in{'update'}])) {
	    &send_upd_real($db[$in{'update'}],
			   &aid_get_usertext($in{'update'}),0);
	} else {
	    &send_upd_real(&blank_rawdata(),'',0);
	}
    } else {
	&send_upd_list();
    }
    exit(0);

} elsif (defined($in{'vcard'})) {
    if ($in{'vcard'} =~ /^\d+$/) {
	@db = &aid_create_db($dbfile);
	if (defined($db[$in{'vcard'}])) {
	    &send_vcard($db[$in{'vcard'}]);
	} else {
	    &send_upd_real(&blank_rawdata(),'',0);
	}
    } else {
	&send_upd_real(&blank_rawdata(),'',0);
    }
    exit(0);

} elsif ($in{'about'} =~ /^\d+$/) {
    @db = &aid_create_db($dbfile);
    if (defined($db[$in{'about'}])) {
	&send_about($db[$in{'about'}]);
    } else {
	&send_upd_real(&blank_rawdata(),'',0);
    }
    exit(0);
}


# no special flags, so this should be a submission-processing request.
# did they access this with the right form?
foreach (@required_headers) {
    if (!defined($in{$_})) {
	# wrong form
	&send_upd_real(&blank_rawdata(),'',0);
	exit(0);
    }
}


# okay, we've got the right form.  clean up the input.
foreach $key (keys(%in)) {
    $in{$key} =~ s/^\s*//;  # get rid of leading and trailing whitespace
    $in{$key} =~ s/\s*$//;

    $in{$key} = '' if $in{$key} =~ m|^n/a$|i;
    $in{$key} = '' if $in{$key} =~ m|^none$|i;
    $in{$key} = '' if $in{$key} =~ m|^\(none\)$|i;
}

# remove apostropies and add a leading year to gradyear field
$in{'grad'} =~ s/^class\s+of\s*//i;
$in{'grad'} =~ s/^\'(\d\d)$/$1/;

# the MS approach to 2-digit year fields: either 35 years in the future,
# or 65 years in the past.
if ($in{'grad'} =~ /^\d\d$/) {
    ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
    $year += 1900;  # localtime() returns number of years since 1900
    if ((($year % 100) - $in{'grad'}) <= 65) {
	$year = int($year / 100);
	$in{'grad'} = $year . $in{'grad'};
    } else {
	$year = int($year / 100);
	$in{'grad'} = ++$year . $in{'grad'};
    }
}

#$in{'request'} = (defined($in{'request'})) ? 1 : 0;
$in{'school'} = ($in{'school'} eq 'Other' && $in{'sch_other'} ne '') ? 
    $in{'sch_other'} : $in{'school'};

# lowercase the hostname portion of the email address
if (!($in{'mail'} =~ /^\s*$/)) {
    ($mail_user, $mail_addr) = split(/\@/, $in{'mail'});
    $mail_addr = 'aol.com' if $mail_addr eq '';
	
    # test for initial-cap, rest lower user
    $lower_user = "\L$mail_user\E";
    $mail_user = $lower_user if $mail_user eq "\u$lower_user";

    # test for all-caps user
    $mail_user = $lower_user if $mail_user eq "\U$mail_user\E";

    $in{'mail'} = $mail_user . '@' . "\L$mail_addr\E";
}

# uncapitalize those overzealous capslock names
$in{'first'} = "\L$in{'first'}\E" 
    if ($in{'first'} eq "\U$in{'first'}\E");
$in{'last'} = "\L$in{'last'}\E"
    if ($in{'last'} eq "\U$in{'last'}\E");
$in{'married'} = "\L$in{'married'}\E" 
    if ($in{'married'} eq "\U$in{'married'}\E");

# capitalize those lazy names
$in{'first'} = "\u$in{'first'}";
$in{'last'} = "\u$in{'last'}";
$in{'married'} = "\u$in{'married'}";

# their personal message
$in{'message'} =~ s/^\s*//;
$in{'message'} =~ s/\s*$//;
$in{'message'} =~ s/&/&amp;/g;
$in{'message'} =~ s/</&lt;/g;
$in{'message'} =~ s/>/&gt;/g;
$in{'message'} =~ s/\"/\'/g;
#$in{'message'} =~ s/\s+/ /g;           # make multiple spaces a single space

# did they check the "other" box for school, but not fill in any text?
if ($in{'school'} eq 'Other') {
    &send_upd_real(&make_rawdata(%in),$in{'message'},1);
    exit(0);
}

# did they have non-blank entries for all the required fields?
foreach (@required_headers) {
    if ($in{$_} =~ /^\s*$/) {
	&send_upd_real(&make_rawdata(%in),$in{'message'},1);
	exit(0);
    }
}

# now that the input is cleaned up, decide whether we're going to enter
# the confirmation phase or the queueing phase.

if (defined($in{'revise'})) {
    &send_upd_real(&make_rawdata(%in),$in{'message'},0);
} elsif (defined($in{'confirmed'})) {
    &queue_submission();
} else {
    &confirm_submission();
}

exit(0);

sub make_rawdata {
    local(%in) = @_;

    return &aid_join(0,$in{'id'},$in{'request'},
		     $in{'last'},$in{'first'},$in{'married'},
		     $in{'school'},$in{'grad'},$in{'mail'},
		     $in{'homepage'},$in{'location'});
}

sub confirm_submission {
    local($cgi_path) = &aid_config('cgi_path');

    # a little more cleanup and then update the db.
    $in{'homepage'} = '' if $in{'homepage'} eq 'http://';

    select(STDOUT);  $| = 1;
    print "Content-type: text/html\n\n";
    print &common_html_hdr(-1,1);

    print "<br>\n";
    print &aid_tableheader('Please confirm your submission');
    print "

<p>Please confirm that all of the below information is correct.  If you
have made any mistakes, select the <strong>&lt;&nbsp;Back</strong> button
to edit your entry.  If everything is correct, please hit the
<strong>Finish</strong> button.</p>\n";

    print "<form method=post action=\"$cgi_path\">\n";
    foreach (keys %in) {
	print "<input type=hidden name=\"$_\" value=\"$in{$_}\">\n";
    }

    print "<table border=0><tr><td>\n";
    print &about_text(";;$in{'request'};$in{'last'};$in{'first'};$in{'married'};$in{'school'};$in{'grad'};$in{'mail'};$in{'homepage'};$in{'location'}",$in{'message'},1,1), "\n";
    print "</td></tr>\n";
    print "<tr><td align=right>\n";
    print "<input type=submit name=\"revise\" value=\"&lt; Back\">\n";
    print "&nbsp;\n";
    print "<input type=submit name=\"confirmed\" value=\"Finish\">\n";
    print "</td></tr></table>\n";
    print "</form>\n";
    print &common_html_ftr(-1);
}

sub queue_submission {
    require 'ctime.pl';

    # a little more cleanup and then update the db.
    $in{'homepage'} = '' if $in{'homepage'} eq 'http://';
    $time = time;
    $date = &ctime($time);
    $mailto = &aid_config('mailto');
    $mailsubj = &aid_config('mailsubj');
    $mailname = &aid_config('admin_name');

    $message_top = 
"Dear $mailname,

This was submitted to the Alumni Internet Directory:

$time;$in{'id'};$in{'request'};$in{'last'};$in{'first'};$in{'married'};$in{'school'};$in{'grad'};$in{'mail'};$in{'homepage'};$in{'location'}
";

    $message_mid =
	(($in{'message'} eq '') ? '' :
	 "_AID_BEGIN_MESSAGE_\n$in{'message'}\n_AID_END_MESSAGE_\n");
    
    $message_bot =
"The kind soul who submitted it was using the web from $ENV{'REMOTE_HOST'}
Their browser is $ENV{'HTTP_USER_AGENT'}

Love,
the mvhsaid cgi-bin script
$date";

    system("$mailprog -s $mailsubj $mailto <<'EOM'
$message_top
$message_mid
$message_bot
EOM
");

    select(STDOUT);  $| = 1;
    print "Content-type: text/html\n\n";
    print &common_html_hdr(-1,1);

    print "<br>\n";
    print &aid_tableheader('Your submission is confirmed and queued');
    $fullname = &inorder_fullname($in{'first'},$in{'last'},$in{'married'});
    print "<p>The entry for <strong>$fullname</strong> has been\n";
    print "added to the submission queue.\n";
    print "Email will be sent to <tt>$in{'mail'}</tt> confirming\n";
    print "receipt of this submission when it it processed.</p>\n";

    print "<p>Processing your sumbission might take a day or two.\n";
    print "See <a href=\"" . &aid_config('master_path') . "tech.html#submit\">";
    print "tech notes</a> for behind-the-scenes details.</p>\n";

    print &common_html_ftr(-1);
}


sub send_upd_real {
    local($rawdata,$message,$blankp) = @_;

    select(STDOUT);  $| = 1;
    print "Content-type: text/html\n\n";

    print &common_html_hdr(-1,1);
    print &submit_body($rawdata,$message,$blankp);
    print &common_html_ftr(-1);
}

sub send_about {
    local($rawdata) = @_;
    local($time,$id,$req,$last,$first,$married,
	  $school,$year,$email,$homepage,$location) = &aid_split($rawdata);
    local($fullname) = &inorder_fullname($first,$last,$married);

    select(STDOUT);  $| = 1;
    print "Content-type: text/html\n\n";
    print &common_html_hdr(-1,1);
    print "<br>\n";
    print &aid_tableheader($fullname);
    print "<p>Here is more detailed information about $fullname.  To see\n";
    print "<a href=\"" . &aid_config('cgi_path') . "/vcard/${id}.vcf\">";
    print "${first}'s vCard</a>,\n";
    print "you must be using Netscape 4 or have the \n";
    print "<a href=\"http://www.nowsoft.com/plugins/about_people.html\">";
    print "About People</a>\n";
    print "plugin installed.  To learn more about vCard, check out the\n";
    print "<a href=\"http://www.imc.org/pdi/\">Internet Mail Consortium</a>'s";
    print " website.\n\n";
    print &about_text($rawdata,'',0,1,1), "\n";
    print &common_html_ftr(-1);
}

sub send_vcard {
    local($rawdata) = @_;
    local($time,$id,$req,$last,$first,$married,
	  $school,$year,$email,$homepage,$location) = &aid_split($rawdata);

    $long_last  = $last;
    $long_last .= " $married" if $married ne '';

    select(STDOUT);  $| = 1;
    print "Content-type: text/x-vCard\n\n";
    print "Begin:vCard\n";
    print "ORG:$school;";
    if ($year =~ /^\d+$/) {
	print "Class of '$year\n";
    } else {
	print "$year\n";
    }
    print "FN: $first $long_last\n";
    print "N:$last;$first;$married\n";
    print "EMAIL;PREF;INTERNET:$email\n";
    print "ADR:$location\n" if $location ne '';
    print "URL:$homepage\n" if $homepage ne '';
    print "End:vCard\n";
}


sub send_upd_list {
    local($_);
    local(@db) = &aid_alpha_db($dbfile);
    local($fullname,$affil,$len);
    local($time,$req,$id,$last,$first,$married,
	  $school,$year,$email,$homepage,$location);

    select(STDOUT);  $| = 1;
    print "Content-type: text/html\n\n";
    print &common_html_hdr(-1,1);
    print "<br>\n";
    print &aid_tableheader('Update Your Directory Listing');
    print "\n";
    print "<p>Please select an entry to update from the list below.<p>\n";
    print "<pre>";
    print "Name and Graduation Year                  Email\n";
    print "---------------------------------------------------------------------------\n";

    foreach (@db) {
	next if $_ eq '';
	($time,$id,$req,$last,$first,$married,
	 $school,$year,$email,$homepage,$location) = &aid_split($_);

	$fullname = &fullname($first,$last,$married);
	($affil,$len) = &affiliate($year,$school,0);

	print "<a href=\"", &aid_config('cgi_path'), "?update=$id\">";
	print $fullname;
	print "</a>";
	print $affil;
	print ' ', ' ' x (41 - (length($fullname) + $len));
	print $email;
	print "\n";
    }
    print "</pre>\n\n";
    print &common_html_ftr(-1);
}

sub panic {
    local($[) = 0;

    select(STDOUT);  $| = 1;
    print "Content-type: text/plain\n\n";
    print $_[0], "\n";

    exit;
}
